var T=Object.defineProperty,S=Object.defineProperties;var b=Object.getOwnPropertyDescriptors;var g=Object.getOwnPropertySymbols;var E=Object.prototype.hasOwnProperty,M=Object.prototype.propertyIsEnumerable;var v=(y,t,o)=>t in y?T(y,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):y[t]=o,m=(y,t)=>{for(var o in t||(t={}))E.call(t,o)&&v(y,o,t[o]);if(g)for(var o of g(t))M.call(t,o)&&v(y,o,t[o]);return y},w=(y,t)=>S(y,b(t));var p=(y,t,o)=>(v(y,typeof t!="symbol"?t+"":t,o),o);var D="./assets/text.48e931be.png";class L{constructor(t,o,e){p(this,"x");p(this,"y");p(this,"size");p(this,"typeCount",7);p(this,"matrix",[]);p(this,"data",[]);p(this,"isHandle",!1);p(this,"isSelect",!1);p(this,"score",0);p(this,"target1",{active:!1});p(this,"target2",{});p(this,"hasMove",!0);this.x=t,this.y=o,this.size=e,this.getMatrix(),this.init(!0)}click(t){if(this.isHandle)return;const{isSelect:o}=this;if(!o)t.active=!0,this.target1=t,this.isSelect=!0;else{if(this.target1===t)return;this.target1.active=!1,["left","top","bottom","right"].some(e=>this.target1[e]==t)?(this.target2=t,(async()=>(await this.swap(),await this.gameLoop()||await this.swap()))(),this.isSelect=!1):(t.active=!0,this.target1=t,this.isSelect=!0)}}swap(){return new Promise((t,o)=>{const{target1:e,target2:s,data:i}=this,{positionLeft:n,positionTop:a,x:r,y:l}=e,{positionLeft:h,positionTop:d,x:u,y:x}=s;e.positionLeft=h,e.positionTop=d,e.x=u,e.y=x,s.positionLeft=n,s.positionTop=a,s.x=r,s.y=l,i.forEach(f=>{f.left=i.find(c=>c.x==f.x-1&&c.y==f.y),f.right=i.find(c=>c.x==f.x+1&&c.y==f.y),f.top=i.find(c=>c.x==f.x&&c.y==f.y-1),f.bottom=i.find(c=>c.x==f.x&&c.y==f.y+1)}),t(!0)})}async gameLoop(t=!1){t&&(this.score=0),this.isHandle=!0,await this.remove();let o=this.data.some(e=>e.status==="remove");for(;this.data.some(e=>e.status==="remove");)await this.down(),await this.add(),await this.remove(),!this.data.some(e=>e.status==="add")&&!this.validate(this.data)&&console.log("\u6CA1\u6709\u53EF\u79FB\u52A8\u7684\u65B9\u5757, \u91CD\u7F6E\u6253\u4E71\u4E2D...");return console.log("data: ",this.data),this.isHandle=!1,o}remove(){return new Promise((t,o)=>{const{data:e}=this;e.forEach(s=>{const{left:i,right:n,top:a,bottom:r,type:l}=s;(i==null?void 0:i.type)==l&&(n==null?void 0:n.type)==l&&(i.status="remove",s.status="remove",n.status="remove"),(a==null?void 0:a.type)==l&&(r==null?void 0:r.type)==l&&(a.status="remove",s.status="remove",r.status="remove")}),setTimeout(()=>{e.forEach((s,i)=>{s.status==="remove"&&(s.scale=0,this.score+=1)})},100),setTimeout(()=>{t(!0)},500)})}down(){return new Promise((t,o)=>{const{data:e,size:s,x:i,y:n}=this;e.forEach((a,r)=>{let l=0;if(a.status==="remove"){let h=a.top;for(;h;)h.status!=="remove"&&(l+=1),h=h.top;l&&(a.y-=l,a.positionTop=a.positionTop-s*l)}else{let h=a.bottom;for(;h;)h.status==="remove"&&(l+=1),h=h.bottom;l&&(a.y+=l,a.positionTop=a.positionTop+s*l)}}),setTimeout(()=>{t(!0)},500)})}add(){return new Promise((t,o)=>{const{size:e,matrix:s}=this;console.log(111),this.getMatrix(),this.matrix=s.map((i,n)=>i.map((a,r)=>this.data.find(l=>r==l.x&&n==l.y))),this.init(),this.data.forEach(i=>{i.status==="add"&&(i.scale=1,i.status="normal")}),t(!0)})}getMatrix(){const{x:t,y:o}=this,e=new Array(t).fill(void 0),s=new Array(o).fill(void 0).map(i=>e);this.matrix=s}validate(t){let o=!1;for(let e=0,s=t.length;e<s;e++){let i=t[e];if(this.validateLine(t[e],!1)){console.log("lineMove: ",t[e],this.validateLine(t[e],!0)),o=!0;break}if(this.validateVertical(t[e])){console.log("verticalMove: ",t[e]),o=!0;break}if(t[e].x>0&&t[e].y>0&&t[e].x<this.x-1&&t[e].y<this.y-1&&this.validate9Grid([[i.leftTop,i.top,i.rightTop],[i.left,i,i.right],[i.leftBottom,i.bottom,i.rightBottom]])){console.log("9GridMove: ",t[e]),o=!0;break}}return console.log("hasMove: ",o),o}validateLine(t,o){const{data:e}=this,s=e.filter(i=>i.x<=t.x+2&&i.x>=t.x-2&&i.y===t.y).map(i=>i.type);return o&&console.log("lineData: ",s,t),s.filter(i=>i===t.type).length>=3&&(s.length===4||s.length===5&&!(s[0]===s[2]&&s[2]===s[4]))}validateVertical(t){const{data:o}=this,e=o.filter(s=>s.y<=t.y+2&&s.y>=t.y-2&&s.x===t.x).map(s=>s.type);return e.filter(s=>s===t.type).length>=3&&(e.length===4||e.length===5&&!(e[0]===e[2]&&e[2]===e[4]))}validate9Grid(t){for(let o=0;o<t.length;o++)for(let e=0;e<t[o].length;e++){if(e<t[o].length-1){if(this.adJacentSwap(t,o,e,o,e+1),this.hasSameNumberInRowOrColumn(t,o)||this.hasSameNumberInRowOrColumn(t,e))return!0;this.adJacentSwap(t,o,e,o,e+1)}if(o<t.length-1){if(this.adJacentSwap(t,o,e,o+1,e),this.hasSameNumberInRowOrColumn(t,o)||this.hasSameNumberInRowOrColumn(t,e))return!0;this.adJacentSwap(t,o,e,o+1,e)}}return!1}adJacentSwap(t,o,e,s,i){const n=t[o][e];t[o][e]=t[s][i],t[s][i]=n}hasSameNumberInRowOrColumn(t,o){return!!(t[o].every((i,n,a)=>i.type===a[0].type)||t.map(i=>i[o]).every((i,n,a)=>i.type===a[0].type))}randomArr(t){const{x:o,size:e}=this;let s=0,i=0,n=t.slice();for(let a=t.length-1;a>0;a--){const r=Math.floor(Math.random()*(a+1));[n[a],n[r]]=[n[r],n[a]]}for(let a=0;a<n.length;a++)n[a]=w(m({},n[a]),{x:s,y:i,positionLeft:e*s,positionTop:e*i}),s++,s===o&&(s=0,i++);return n=this.addAroundData(n),n}addAroundData(t){return t.forEach(o=>{o.left=t.find(e=>e.x==o.x-1&&e.y==o.y),o.right=t.find(e=>e.x==o.x+1&&e.y==o.y),o.top=t.find(e=>e.x==o.x&&e.y==o.y-1),o.bottom=t.find(e=>e.x==o.x&&e.y==o.y+1),o.leftTop=t.find(e=>e.x==o.x-1&&e.y==o.y-1),o.rightTop=t.find(e=>e.x==o.x+1&&e.y==o.y-1),o.leftBottom=t.find(e=>e.x==o.x-1&&e.y==o.y+1),o.rightBottom=t.find(e=>e.x==o.x+1&&e.y==o.y+1)}),t}reset(){console.log("\u6CA1\u6709\u53EF\u79FB\u52A8\u7684\u65B9\u5757, \u91CD\u7F6E\u6253\u4E71\u4E2D...");let t=this.randomArr(this.data);if(t.some(o=>{var e,s,i,n;return o.type===((e=o.left)==null?void 0:e.type)&&o.type===((s=o.right)==null?void 0:s.type)||o.type===((i=o.top)==null?void 0:i.type)&&o.type===((n=o.bottom)==null?void 0:n.type)})){this.reset();return}if(!this.validate(t)){this.reset();return}console.log("\u79FB\u52A8data: ",t),this.setData(t)}init(t=!1){const{x:o,y:e,typeCount:s,matrix:i,size:n}=this;let a=[],r=0,l=0;for(let h=0,d=Math.pow(o,2);h<d;h++){let u;try{u=i[l][r]}catch{}let x=u&&u.status!=="remove",f={type:x?u.type:Math.floor(Math.random()*s),x:r,y:l,status:t||x?"normal":"add",positionLeft:x?u.positionLeft:n*r,positionTop:x?u.positionTop:n*l,left:void 0,top:void 0,bottom:void 0,right:void 0,scale:t||x?1:0,key:u?u.key+h:`${r}${l}`,active:!1};a.push(f),r++,r==o&&(r=0,l++)}if(a=this.addAroundData(a),console.log(a),!this.validate(a)){this.init(t);return}this.data=a}setData(t){this.data=t}scale(){let{data:t}=this;t[0]=w(m({},t[0]),{scale:t[0].scale===1?0:1}),this.setData(t)}}export{L as S,D as _};
